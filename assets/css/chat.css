/* ============================================================
   CHAT.CSS  —  Namak Messenger
   Chat window: message list, bubbles, input bar, media
   Depends on: base.css, app.css
   ============================================================ */

/* ──────────────────────────────────────────────────────────
   1. CHAT LAYOUT
────────────────────────────────────────────────────────── */
.chat-window {
    display:        flex;
    flex-direction: column;
    height:         100%;
    overflow:       hidden;
    position:       relative;
    background:     var(--chat-bg, var(--bg));
}

/* Chat background patterns */
.chat-window[data-bg="dots"] {
    background-image: radial-gradient(
            circle, var(--border) 1px, transparent 1px
    );
    background-size: 20px 20px;
}
.chat-window[data-bg="lines"] {
    background-image: repeating-linear-gradient(
            0deg,
            transparent,
            transparent 28px,
            var(--border-light) 28px,
            var(--border-light) 29px
    );
}
.chat-window[data-bg="grid"] {
    background-image:
            linear-gradient(var(--border-light) 1px, transparent 1px),
            linear-gradient(90deg, var(--border-light) 1px, transparent 1px);
    background-size: 24px 24px;
}

/* ──────────────────────────────────────────────────────────
   2. MESSAGE LIST
────────────────────────────────────────────────────────── */
.message-list {
    flex:              1;
    overflow-y:        auto;
    overflow-x:        hidden;
    padding:           var(--space-3) var(--space-4);
    display:           flex;
    flex-direction:    column;
    gap:               2px;
    overscroll-behavior: contain;
    scroll-behavior:   smooth;
    padding-bottom:    var(--space-4);
}

/* Reverse scroll anchor */
.message-list__anchor {
    height:     1px;
    flex-shrink:0;
}

/* Load more button */
.message-list__load-more {
    display:         flex;
    justify-content: center;
    padding:         var(--space-3) 0;
}

/* Date separator */
.msg-date-separator {
    display:         flex;
    justify-content: center;
    align-items:     center;
    padding:         var(--space-3) 0 var(--space-2);
    pointer-events:  none;
    user-select:     none;
}
.msg-date-separator__label {
    padding:       var(--space-1) var(--space-4);
    background:    var(--surface);
    border:        1px solid var(--border-light);
    border-radius: var(--radius-full);
    font-size:     var(--text-xs);
    font-weight:   var(--weight-medium);
    color:         var(--text-muted);
    box-shadow:    var(--shadow-xs);
}

/* ──────────────────────────────────────────────────────────
   3. MESSAGE ROW  (wrapper)
────────────────────────────────────────────────────────── */
.msg-row {
    display:        flex;
    align-items:    flex-end;
    gap:            var(--space-2);
    max-width:      100%;
    padding:        1px 0;
    position:       relative;
}

/* Outgoing (right) */
.msg-row--out {
    flex-direction: row-reverse;
}

/* Group messages (no avatar gap repeat) */
.msg-row--group-start  { margin-top:  var(--space-2); }
.msg-row--group-middle { padding: 0; }
.msg-row--group-end    { margin-bottom: var(--space-1); }

/* Selected */
.msg-row--selected .msg-bubble {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}

/* Highlighted (search jump) */
.msg-row--highlighted .msg-bubble {
    background: var(--warning-light) !important;
    transition: background 0.6s ease;
}

/* Avatar beside message */
.msg-row__avatar {
    width:       32px;
    height:      32px;
    flex-shrink: 0;
    align-self:  flex-end;
    margin-bottom: 2px;
}
/* Hide avatar on group messages (middle/end show blank space) */
.msg-row--group-middle .msg-row__avatar,
.msg-row--group-end    .msg-row__avatar {
    visibility: hidden;
}

/* ──────────────────────────────────────────────────────────
   4. MESSAGE BUBBLE
────────────────────────────────────────────────────────── */
.msg-bubble {
    position:      relative;
    max-width:     min(520px, 72vw);
    min-width:     60px;
    padding:       var(--space-2) var(--space-3);
    border-radius: var(--radius-xl);
    word-break:    break-word;
    overflow-wrap: break-word;
    transition:    background var(--transition-fast);
    cursor:        default;
    user-select:   text;
    -webkit-user-select: text;
}

/* Bubble tails */
.msg-row--in  .msg-row--group-start .msg-bubble,
.msg-row--in  .msg-bubble {
    background:    var(--bubble-in);
    color:         var(--bubble-in-text);
    border-bottom-left-radius: var(--radius-xs);
    box-shadow:    var(--shadow-xs);
}
.msg-row--out .msg-bubble {
    background:    var(--bubble-out);
    color:         var(--bubble-out-text);
    border-bottom-right-radius: var(--radius-xs);
    box-shadow:    var(--shadow-xs);
}

[dir="rtl"] .msg-row--in  .msg-bubble { border-bottom-left-radius: var(--radius-xl); border-bottom-right-radius: var(--radius-xs); }
[dir="rtl"] .msg-row--out .msg-bubble { border-bottom-right-radius: var(--radius-xl); border-bottom-left-radius: var(--radius-xs); }

/* Middle / end in group — no tail */
.msg-row--group-middle .msg-bubble,
.msg-row--group-end    .msg-bubble {
    border-radius: var(--radius-xl);
}

/* Hover actions trigger */
.msg-bubble:hover .msg-actions { opacity: 1; pointer-events: auto; }

/* ──────────────────────────────────────────────────────────
   5. SENDER NAME (group chats)
────────────────────────────────────────────────────────── */
.msg-sender {
    font-size:   var(--text-xs);
    font-weight: var(--weight-semibold);
    margin-bottom: 2px;
    line-height:  1;
}
/* Different colors per sender — set via inline style or data-color */
.msg-sender[data-color="0"] { color: #f44336; }
.msg-sender[data-color="1"] { color: #e91e63; }
.msg-sender[data-color="2"] { color: #9c27b0; }
.msg-sender[data-color="3"] { color: #3f51b5; }
.msg-sender[data-color="4"] { color: #2196f3; }
.msg-sender[data-color="5"] { color: #009688; }
.msg-sender[data-color="6"] { color: #4caf50; }
.msg-sender[data-color="7"] { color: #ff9800; }

/* ──────────────────────────────────────────────────────────
   6. MESSAGE TEXT CONTENT
────────────────────────────────────────────────────────── */
.msg-text {
    font-size:   var(--msg-font-size);
    line-height: var(--leading-relaxed);
    color:       inherit;
    white-space: pre-wrap;
    overflow-wrap: break-word;
    word-break:  break-word;
}

/* Links inside messages */
.msg-text a {
    color:           var(--primary);
    text-decoration: underline;
    word-break:      break-all;
}
.msg-row--out .msg-text a {
    color: var(--primary-active);
}

/* Inline code */
.msg-text code {
    background:    rgba(0,0,0,0.08);
    border-radius: var(--radius-xs);
    padding:       1px 4px;
    font-size:     0.9em;
}
[data-theme="dark"] .msg-text code {
    background: rgba(255,255,255,0.1);
}

/* Bold / italic markdown */
.msg-text strong { font-weight: var(--weight-semibold); }
.msg-text em     { font-style: italic; }
.msg-text del    { text-decoration: line-through; opacity: 0.7; }
.msg-text u      { text-decoration: underline; }

/* ──────────────────────────────────────────────────────────
   7. MESSAGE META  (time + ticks)
────────────────────────────────────────────────────────── */
.msg-meta {
    display:     inline-flex;
    align-items: center;
    gap:         var(--space-1);
    float:       right;
    margin-left: var(--space-3);
    margin-top:  2px;
    margin-bottom: -2px;
    line-height: 1;
    user-select: none;
    pointer-events: none;
}
[dir="rtl"] .msg-meta {
    float:        left;
    margin-left:  0;
    margin-right: var(--space-3);
}

.msg-meta__time {
    font-size:   10px;
    color:       var(--bubble-meta);
    white-space: nowrap;
}
.msg-row--out .msg-meta__time { color: var(--bubble-meta); }

/* Tick icons */
.msg-meta__ticks {
    display:     flex;
    align-items: center;
    color:       var(--bubble-meta);
}
.msg-meta__ticks svg   { width: 14px; height: 14px; }
.msg-meta__ticks--read { color: var(--primary); }

/* Edited label */
.msg-meta__edited {
    font-size:  10px;
    color:      var(--bubble-meta);
    font-style: italic;
}

/* Sending spinner */
.msg-meta__sending .spinner {
    width:  10px;
    height: 10px;
    border-width: 1.5px;
}

/* Failed */
.msg-meta__failed {
    color:   var(--text-danger);
    font-size: 12px;
    cursor:  pointer;
}

/* Clear float */
.msg-bubble::after {
    content: '';
    display: table;
    clear:   both;
}

/* ──────────────────────────────────────────────────────────
   8. REPLY PREVIEW  (inside bubble)
────────────────────────────────────────────────────────── */
.msg-reply {
    display:       flex;
    gap:           var(--space-2);
    padding:       var(--space-2) var(--space-2) var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    background:    rgba(0,0,0,0.06);
    margin-bottom: var(--space-2);
    cursor:        pointer;
    border-left:   3px solid var(--primary);
    transition:    background var(--transition-fast);
    overflow:      hidden;
}
.msg-reply:hover { background: rgba(0,0,0,0.1); }
[dir="rtl"] .msg-reply { border-left: none; border-right: 3px solid var(--primary); }

[data-theme="dark"] .msg-reply          { background: rgba(255,255,255,0.06); }
[data-theme="dark"] .msg-reply:hover    { background: rgba(255,255,255,0.1); }

.msg-reply__thumb {
    width:         36px;
    height:        36px;
    border-radius: var(--radius-sm);
    object-fit:    cover;
    flex-shrink:   0;
}
.msg-reply__body  { flex: 1; min-width: 0; }
.msg-reply__name  {
    font-size:     var(--text-xs);
    font-weight:   var(--weight-semibold);
    color:         var(--primary);
    overflow:      hidden;
    white-space:   nowrap;
    text-overflow: ellipsis;
}
.msg-reply__text {
    font-size:     var(--text-xs);
    color:         var(--bubble-meta);
    overflow:      hidden;
    white-space:   nowrap;
    text-overflow: ellipsis;
    margin-top:    1px;
}

/* ──────────────────────────────────────────────────────────
   9. FORWARD LABEL
────────────────────────────────────────────────────────── */
.msg-forward-label {
    display:     flex;
    align-items: center;
    gap:         var(--space-1);
    font-size:   var(--text-xs);
    color:       var(--text-muted);
    font-style:  italic;
    margin-bottom:var(--space-1);
}
.msg-forward-label svg { width: 13px; height: 13px; }

/* ──────────────────────────────────────────────────────────
   10. MESSAGE REACTIONS
────────────────────────────────────────────────────────── */
.msg-reactions {
    display:     flex;
    flex-wrap:   wrap;
    gap:         3px;
    margin-top:  var(--space-1);
}

.msg-reaction {
    display:       inline-flex;
    align-items:   center;
    gap:           3px;
    padding:       2px 7px;
    background:    var(--surface);
    border:        1.5px solid var(--border-light);
    border-radius: var(--radius-full);
    font-size:     var(--text-xs);
    cursor:        pointer;
    transition:    background  var(--transition-fast),
    border-color var(--transition-fast),
    transform   var(--transition-spring);
    user-select:   none;
    line-height:   1;
}
.msg-reaction:hover   { background: var(--surface-3); transform: scale(1.08); }
.msg-reaction--mine   {
    background:   var(--primary-light);
    border-color: var(--primary);
    color:        var(--primary);
}
.msg-reaction__emoji  { font-size: 14px; }
.msg-reaction__count  { font-weight: var(--weight-semibold); }

/* ──────────────────────────────────────────────────────────
   11. MESSAGE ACTIONS  (hover toolbar)
────────────────────────────────────────────────────────── */
.msg-actions {
    position:   absolute;
    top:        -18px;
    right:      var(--space-2);
    display:    flex;
    align-items:center;
    gap:        2px;
    background: var(--surface-elevated);
    border:     1px solid var(--border-light);
    border-radius: var(--radius-full);
    padding:    2px 4px;
    box-shadow: var(--shadow-md);
    opacity:    0;
    pointer-events: none;
    transition: opacity var(--transition-fast);
    z-index:    var(--z-dropdown);
    white-space:nowrap;
}
.msg-row--out .msg-actions {
    right: auto;
    left:  var(--space-2);
}
[dir="rtl"] .msg-actions        { right: auto; left:  var(--space-2); }
[dir="rtl"] .msg-row--out .msg-actions { left: auto; right: var(--space-2); }

.msg-action-btn {
    width:         24px;
    height:        24px;
    border-radius: 50%;
    display:       flex;
    align-items:   center;
    justify-content:center;
    color:         var(--text-muted);
    font-size:     14px;
    transition:    background var(--transition-fast),
    color      var(--transition-fast);
    cursor:        pointer;
}
.msg-action-btn:hover {
    background: var(--surface-3);
    color:      var(--text);
}
.msg-action-btn svg { width: 14px; height: 14px; }

/* ──────────────────────────────────────────────────────────
   12. EMOJI PICKER  (quick reaction row)
────────────────────────────────────────────────────────── */
.emoji-quick-bar {
    position:      absolute;
    top:           -52px;
    right:         var(--space-2);
    display:       flex;
    align-items:   center;
    gap:           2px;
    background:    var(--surface-elevated);
    border:        1px solid var(--border-light);
    border-radius: var(--radius-full);
    padding:       4px 8px;
    box-shadow:    var(--shadow-lg);
    z-index:       calc(var(--z-dropdown) + 1);
    animation:     scaleIn 120ms ease both;
}
.msg-row--out .emoji-quick-bar { right: auto; left: var(--space-2); }

.emoji-quick-btn {
    font-size:     20px;
    cursor:        pointer;
    padding:       2px;
    border-radius: var(--radius-sm);
    transition:    transform var(--transition-spring),
    background var(--transition-fast);
    line-height:   1;
    user-select:   none;
}
.emoji-quick-btn:hover {
    transform:  scale(1.3);
    background: var(--overlay-light);
}

/* ──────────────────────────────────────────────────────────
   13. MEDIA MESSAGES
────────────────────────────────────────────────────────── */

/* ── Image ── */
.msg-image {
    display:        block;
    position:       relative;
    border-radius:  var(--radius-lg);
    overflow:       hidden;
    cursor:         pointer;
    line-height:    0;
    margin:         -2px;
    background:     var(--surface-3);
}
.msg-image img {
    display:    block;
    max-width:  320px;
    max-height: 320px;
    width:      100%;
    object-fit: cover;
    transition: filter var(--transition-base);
    border-radius: var(--radius-lg);
}
.msg-image:hover img { filter: brightness(0.92); }
.msg-image__overlay {
    position:        absolute;
    inset:           0;
    display:         flex;
    align-items:     center;
    justify-content: center;
    background:      rgba(0,0,0,0.35);
    opacity:         0;
    transition:      opacity var(--transition-base);
    border-radius:   var(--radius-lg);
}
.msg-image:hover .msg-image__overlay { opacity: 1; }
.msg-image__overlay svg {
    width:  32px;
    height: 32px;
    color:  white;
}
/* Blurhash placeholder */
.msg-image__blur {
    position:   absolute;
    inset:      0;
    filter:     blur(8px);
    transform:  scale(1.05);
    transition: opacity var(--transition-slow);
}
.msg-image--loaded .msg-image__blur { opacity: 0; }

/* Meta badge on images (time shown over image) */
.msg-image .msg-meta {
    position:   absolute;
    bottom:     var(--space-2);
    right:      var(--space-2);
    background: rgba(0,0,0,0.45);
    padding:    2px 6px;
    border-radius: var(--radius-full);
    float:      none;
    margin:     0;
    backdrop-filter: blur(4px);
}
.msg-image .msg-meta .msg-meta__time { color: rgba(255,255,255,0.9); }
[dir="rtl"] .msg-image .msg-meta { right: auto; left: var(--space-2); }

/* ── Video ── */
.msg-video {
    position:       relative;
    border-radius:  var(--radius-lg);
    overflow:       hidden;
    cursor:         pointer;
    background:     var(--surface-3);
    line-height:    0;
    max-width:      320px;
}
.msg-video video,
.msg-video__thumb {
    display:        block;
    width:          100%;
    max-height:     320px;
    object-fit:     cover;
    border-radius:  var(--radius-lg);
}
.msg-video__play {
    position:        absolute;
    inset:           0;
    display:         flex;
    align-items:     center;
    justify-content: center;
    background:      rgba(0,0,0,0.3);
}
.msg-video__play-btn {
    width:           52px;
    height:          52px;
    background:      rgba(255,255,255,0.9);
    border-radius:   50%;
    display:         flex;
    align-items:     center;
    justify-content: center;
    transition:      transform var(--transition-spring),
    background var(--transition-base);
}
.msg-video__play-btn:hover { background: white; transform: scale(1.1); }
.msg-video__play-btn svg  { width: 22px; height: 22px; color: var(--text); margin-left: 3px; }

.msg-video__duration {
    position:      absolute;
    bottom:        var(--space-2);
    left:          var(--space-2);
    background:    rgba(0,0,0,0.5);
    color:         white;
    font-size:     var(--text-xs);
    padding:       2px 6px;
    border-radius: var(--radius-full);
}
[dir="rtl"] .msg-video__duration { left: auto; right: var(--space-2); }

/* ── Audio ── */
.msg-audio {
    display:     flex;
    align-items: center;
    gap:         var(--space-3);
    min-width:   200px;
    max-width:   280px;
    padding:     var(--space-1) 0;
}
.msg-audio__play-btn {
    width:           36px;
    height:          36px;
    background:      var(--primary);
    border-radius:   50%;
    display:         flex;
    align-items:     center;
    justify-content: center;
    flex-shrink:     0;
    transition:      background var(--transition-base),
    transform  var(--transition-spring);
    cursor:          pointer;
}
.msg-audio__play-btn:hover    { transform: scale(1.08); }
.msg-audio__play-btn svg      { width: 14px; height: 14px; color: white; }
.msg-audio__play-btn--playing { background: var(--primary-hover); }

.msg-audio__body  { flex: 1; min-width: 0; }
.msg-audio__waveform {
    display:    flex;
    align-items:center;
    gap:        2px;
    height:     28px;
    cursor:     pointer;
}
.msg-audio__bar {
    width:         3px;
    border-radius: var(--radius-full);
    background:    rgba(var(--primary-rgb), 0.3);
    flex-shrink:   0;
    transition:    background var(--transition-fast);
    min-height:    3px;
}
.msg-audio__bar--played { background: var(--primary); }
.msg-audio__duration {
    font-size: var(--text-xs);
    color:     var(--bubble-meta);
    margin-top:2px;
}

/* Voice note indicator */
.msg-audio__voice-badge {
    display:     flex;
    align-items: center;
    gap:         var(--space-1);
    font-size:   var(--text-xs);
    color:       var(--text-muted);
}
.msg-audio__voice-badge svg { width: 12px; height: 12px; }

/* ── Document / File ── */
.msg-file {
    display:     flex;
    align-items: center;
    gap:         var(--space-3);
    min-width:   180px;
    max-width:   280px;
}
.msg-file__icon {
    width:           44px;
    height:          44px;
    border-radius:   var(--radius-md);
    background:      var(--primary-light);
    display:         flex;
    align-items:     center;
    justify-content: center;
    flex-shrink:     0;
    font-size:       20px;
}
.msg-file__icon svg { width: 22px; height: 22px; color: var(--primary); }

.msg-file__body   { flex: 1; min-width: 0; }
.msg-file__name {
    font-size:     var(--text-sm);
    font-weight:   var(--weight-medium);
    color:         var(--text);
    overflow:      hidden;
    white-space:   nowrap;
    text-overflow: ellipsis;
}
.msg-file__size {
    font-size: var(--text-xs);
    color:     var(--bubble-meta);
    margin-top:2px;
}
.msg-file__download {
    width:       32px;
    height:      32px;
    border-radius:50%;
    display:     flex;
    align-items: center;
    justify-content:center;
    color:       var(--primary);
    flex-shrink: 0;
    transition:  background var(--transition-fast),
    transform  var(--transition-spring);
    cursor:      pointer;
}
.msg-file__download:hover {
    background: var(--primary-light);
    transform:  scale(1.1);
}
.msg-file__download svg { width: 16px; height: 16px; }

/* Download progress */
.msg-file__progress {
    height:        3px;
    background:    var(--border);
    border-radius: var(--radius-full);
    margin-top:    var(--space-1);
    overflow:      hidden;
}
.msg-file__progress-bar {
    height:     100%;
    background: var(--primary);
    border-radius: var(--radius-full);
    transition: width 0.3s ease;
}

/* ── Sticker ── */
.msg-sticker {
    background: transparent !important;
    box-shadow: none !important;
    padding:    0 !important;
}
.msg-sticker img {
    width:  160px;
    height: 160px;
    object-fit: contain;
    filter: drop-shadow(0 2px 6px rgba(0,0,0,0.15));
}

/* ── GIF ── */
.msg-gif {
    position:      relative;
    border-radius: var(--radius-lg);
    overflow:      hidden;
    cursor:        pointer;
    line-height:   0;
}
.msg-gif img {
    max-width:  240px;
    max-height: 240px;
    object-fit: cover;
    border-radius: var(--radius-lg);
    display: block;
}
.msg-gif__label {
    position:      absolute;
    top:           var(--space-1);
    left:          var(--space-2);
    background:    rgba(0,0,0,0.5);
    color:         white;
    font-size:     var(--text-xs);
    font-weight:   var(--weight-bold);
    padding:       1px 5px;
    border-radius: var(--radius-xs);
    letter-spacing:0.05em;
}

/* ── Album / Media Grid ── */
.msg-album {
    display:        grid;
    gap:            2px;
    border-radius:  var(--radius-lg);
    overflow:       hidden;
    max-width:      320px;
}
.msg-album--2 { grid-template-columns: 1fr 1fr; }
.msg-album--3 { grid-template-columns: 1fr 1fr; }
.msg-album--3 .msg-album__item:first-child { grid-row: span 2; }
.msg-album--4 { grid-template-columns: 1fr 1fr; }
.msg-album--5 { grid-template-columns: repeat(3, 1fr); }
.msg-album--5 .msg-album__item:nth-child(-n+2) { grid-column: span 1; }

.msg-album__item {
    position:   relative;
    overflow:   hidden;
    cursor:     pointer;
    line-height:0;
    min-height: 80px;
    background: var(--surface-3);
}
.msg-album__item img {
    width:      100%;
    height:     120px;
    object-fit: cover;
    display:    block;
    transition: filter var(--transition-base);
}
.msg-album__item:hover img { filter: brightness(0.88); }

/* "+N more" overlay on last item */
.msg-album__more {
    position:        absolute;
    inset:           0;
    background:      rgba(0,0,0,0.5);
    display:         flex;
    align-items:     center;
    justify-content: center;
    color:           white;
    font-size:       var(--text-xl);
    font-weight:     var(--weight-bold);
}

/* ── Location ── */
.msg-location {
    border-radius: var(--radius-lg);
    overflow:      hidden;
    cursor:        pointer;
    max-width:     260px;
}
.msg-location__map {
    width:       100%;
    height:      140px;
    object-fit:  cover;
    display:     block;
    background:  var(--surface-3);
}
.msg-location__info {
    padding:       var(--space-2) var(--space-3);
    background:    var(--surface);
    display:       flex;
    align-items:   center;
    gap:           var(--space-2);
}
.msg-location__info svg { width: 16px; height: 16px; color: var(--danger); flex-shrink: 0; }
.msg-location__label {
    font-size:     var(--text-xs);
    color:         var(--text-secondary);
    overflow:      hidden;
    white-space:   nowrap;
    text-overflow: ellipsis;
}

/* ── Poll ── */
.msg-poll {
    min-width: 220px;
    max-width: 300px;
}
.msg-poll__question {
    font-size:   var(--text-sm);
    font-weight: var(--weight-semibold);
    margin-bottom:var(--space-3);
    color:       var(--text);
}
.msg-poll__options {
    display:        flex;
    flex-direction: column;
    gap:            var(--space-2);
}
.msg-poll__option {
    position:      relative;
    padding:       var(--space-2) var(--space-3);
    border:        1.5px solid var(--border);
    border-radius: var(--radius-md);
    cursor:        pointer;
    overflow:      hidden;
    transition:    border-color var(--transition-base);
    font-size:     var(--text-sm);
    color:         var(--text);
}
.msg-poll__option:hover        { border-color: var(--primary); }
.msg-poll__option--voted       { border-color: var(--primary); }
.msg-poll__option--leading     { border-color: var(--success); }
.msg-poll__option-bar {
    position:   absolute;
    inset:      0;
    background: var(--primary-light);
    transform-origin: left center;
    z-index:    0;
    transition: width 0.5s ease;
}
[dir="rtl"] .msg-poll__option-bar { transform-origin: right center; }

.msg-poll__option-content {
    position:    relative;
    z-index:     1;
    display:     flex;
    align-items: center;
    justify-content:space-between;
}
.msg-poll__pct {
    font-size:   var(--text-xs);
    color:       var(--text-muted);
    font-weight: var(--weight-medium);
}
.msg-poll__meta {
    margin-top: var(--space-2);
    font-size:  var(--text-xs);
    color:      var(--text-muted);
}

/* ── Contact Card ── */
.msg-contact-card {
    display:     flex;
    align-items: center;
    gap:         var(--space-3);
    min-width:   200px;
    max-width:   280px;
    padding:     var(--space-1) 0;
}
.msg-contact-card__info   { flex: 1; min-width: 0; }
.msg-contact-card__name {
    font-size:   var(--text-sm);
    font-weight: var(--weight-semibold);
    color:       var(--text);
}
.msg-contact-card__phone {
    font-size: var(--text-xs);
    color:     var(--text-muted);
}
.msg-contact-card__actions {
    display:        flex;
    flex-direction: column;
    gap:            var(--space-1);
    margin-top:     var(--space-2);
    padding-top:    var(--space-2);
    border-top:     1px solid var(--border-light);
}

/* ──────────────────────────────────────────────────────────
   14. LINK PREVIEW
────────────────────────────────────────────────────────── */
.msg-link-preview {
    border-left:   3px solid var(--primary);
    padding:       var(--space-2) var(--space-3);
    margin-top:    var(--space-2);
    background:    rgba(0,0,0,0.04);
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
    cursor:        pointer;
    transition:    background var(--transition-fast);
    overflow:      hidden;
}
.msg-link-preview:hover { background: rgba(0,0,0,0.08); }
[data-theme="dark"] .msg-link-preview { background: rgba(255,255,255,0.05); }
[dir="rtl"] .msg-link-preview {
    border-left:   none;
    border-right:  3px solid var(--primary);
    border-radius: var(--radius-md) 0 0 var(--radius-md);
}

.msg-link-preview__site   {
    font-size:  var(--text-xs);
    color:      var(--primary);
    font-weight:var(--weight-medium);
    margin-bottom: 2px;
}
.msg-link-preview__title  {
    font-size:     var(--text-sm);
    font-weight:   var(--weight-semibold);
    color:         var(--text);
    overflow:      hidden;
    white-space:   nowrap;
    text-overflow: ellipsis;
}
.msg-link-preview__desc   {
    font-size:          var(--text-xs);
    color:              var(--text-muted);
    margin-top:         2px;
    display:            -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow:           hidden;
}
.msg-link-preview__image  {
    width:         100%;
    height:        120px;
    object-fit:    cover;
    border-radius: var(--radius-md);
    margin-top:    var(--space-2);
    display:       block;
}

/* ──────────────────────────────────────────────────────────
   15. INPUT BAR
────────────────────────────────────────────────────────── */
.chat-input-bar {
    background:    var(--surface);
    border-top:    1px solid var(--border-light);
    padding:       var(--space-2) var(--space-3);
    padding-bottom:calc(var(--space-2) + var(--safe-bottom));
    display:       flex;
    flex-direction:column;
    gap:           var(--space-2);
    flex-shrink:   0;
    z-index:       var(--z-sticky);
}

/* ── Reply / Edit preview bar ── */
.chat-input-bar__context {
    display:     flex;
    align-items: center;
    gap:         var(--space-3);
    padding:     var(--space-2) var(--space-3);
    background:  var(--surface-3);
    border-radius:var(--radius-md);
    border-left: 3px solid var(--primary);
    animation:   slideDown var(--transition-base) both;
}
[dir="rtl"] .chat-input-bar__context {
    border-left:  none;
    border-right: 3px solid var(--primary);
}

.chat-input-bar__context-type {
    font-size:   var(--text-xs);
    font-weight: var(--weight-semibold);
    color:       var(--primary);
    line-height: 1;
    margin-bottom:2px;
}
.chat-input-bar__context-text {
    font-size:     var(--text-xs);
    color:         var(--text-muted);
    overflow:      hidden;
    white-space:   nowrap;
    text-overflow: ellipsis;
    flex:          1;
    min-width:     0;
}
.chat-input-bar__context-thumb {
    width:         36px;
    height:        36px;
    border-radius: var(--radius-sm);
    object-fit:    cover;
    flex-shrink:   0;
}

/* ── Main input row ── */
.chat-input-bar__row {
    display:     flex;
    align-items: flex-end;
    gap:         var(--space-2);
}

/* Textarea */
.chat-input {
    flex:          1;
    min-width:     0;
    max-height:    140px;
    padding:       10px var(--space-3);
    background:    var(--input-bg);
    border:        1.5px solid transparent;
    border-radius: var(--radius-2xl);
    font-size:     var(--msg-font-size);
    color:         var(--text);
    line-height:   var(--leading-normal);
    resize:        none;
    overflow-y:    auto;
    transition:    border-color var(--transition-base),
    background   var(--transition-base);
    scrollbar-width: none;
}
.chat-input::-webkit-scrollbar { display: none; }
.chat-input::placeholder { color: var(--input-placeholder); }
.chat-input:focus {
    background:   var(--input-bg-focus);
    border-color: var(--border-focus);
    outline:      none;
}

/* Attach / Emoji buttons */
.chat-input-bar__attach,
.chat-input-bar__emoji {
    flex-shrink: 0;
    align-self:  flex-end;
    margin-bottom: 3px;
    color:       var(--text-muted);
}
.chat-input-bar__attach:hover,
.chat-input-bar__emoji:hover { color: var(--primary); }

/* Send / Record button */
.chat-input-bar__send {
    width:           40px;
    height:          40px;
    min-width:       40px;
    background:      var(--primary);
    color:           white;
    border-radius:   50%;
    display:         flex;
    align-items:     center;
    justify-content: center;
    flex-shrink:     0;
    align-self:      flex-end;
    transition:      background var(--transition-base),
    transform  var(--transition-spring),
    opacity    var(--transition-base);
    box-shadow:      0 2px 8px rgba(var(--primary-rgb), 0.4);
    cursor:          pointer;
}
.chat-input-bar__send:hover   { background: var(--primary-hover); transform: scale(1.08); }
.chat-input-bar__send:active  { transform: scale(0.94); }
.chat-input-bar__send:disabled{ opacity: 0.5; cursor: not-allowed; transform: none; }
.chat-input-bar__send svg     { width: 20px; height: 20px; }

/* Voice record mode */
.chat-input-bar__send--record { background: var(--success); }
.chat-input-bar__send--record:hover { background: #388e3c; }

/* ── Recording bar ── */
.chat-recording-bar {
    display:     flex;
    align-items: center;
    gap:         var(--space-3);
    flex:        1;
    animation:   fadeIn var(--transition-base) both;
}
.chat-recording-bar__dot {
    width:         8px;
    height:        8px;
    background:    var(--danger);
    border-radius: 50%;
    animation:     pulse 1s ease-in-out infinite;
    flex-shrink:   0;
}
.chat-recording-bar__time {
    font-size:   var(--text-sm);
    font-weight: var(--weight-medium);
    color:       var(--text);
    font-variant-numeric: tabular-nums;
}
.chat-recording-bar__cancel {
    font-size: var(--text-sm);
    color:     var(--text-danger);
    cursor:    pointer;
    margin-left:auto;
}
[dir="rtl"] .chat-recording-bar__cancel { margin-left: 0; margin-right: auto; }

/* ──────────────────────────────────────────────────────────
   16. ATTACH MENU  (popup above input)
────────────────────────────────────────────────────────── */
.attach-menu {
    position:      absolute;
    bottom:        calc(100% + var(--space-2));
    left:          var(--space-3);
    display:       flex;
    flex-direction:column;
    gap:           var(--space-1);
    background:    var(--surface-elevated);
    border:        1px solid var(--border-light);
    border-radius: var(--radius-xl);
    padding:       var(--space-2);
    box-shadow:    var(--shadow-xl);
    z-index:       var(--z-dropdown);
    animation:     scaleIn 150ms ease both;
    transform-origin: bottom left;
}
.attach-menu[hidden] { display: none; }
[dir="rtl"] .attach-menu {
    left:  auto;
    right: var(--space-3);
    transform-origin: bottom right;
}

.attach-menu__item {
    display:       flex;
    align-items:   center;
    gap:           var(--space-3);
    padding:       var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    font-size:     var(--text-sm);
    color:         var(--text-secondary);
    cursor:        pointer;
    transition:    background var(--transition-fast),
    color      var(--transition-fast);
    white-space:   nowrap;
}
.attach-menu__item:hover { background: var(--surface-3); color: var(--text); }
.attach-menu__icon {
    width:           36px;
    height:          36px;
    border-radius:   var(--radius-full);
    display:         flex;
    align-items:     center;
    justify-content: center;
    font-size:       18px;
    flex-shrink:     0;
}
.attach-menu__icon--image    { background: var(--info-light);    color: var(--info); }
.attach-menu__icon--file     { background: var(--warning-light); color: var(--warning); }
.attach-menu__icon--location { background: var(--danger-light);  color: var(--danger); }
.attach-menu__icon--contact  { background: var(--success-light); color: var(--success); }
.attach-menu__icon--poll     { background: var(--primary-light); color: var(--primary); }
.attach-menu__icon--gif      { background: var(--primary-light); color: var(--primary); }

/* ──────────────────────────────────────────────────────────
   17. EMOJI PANEL
────────────────────────────────────────────────────────── */
.emoji-panel {
    position:      absolute;
    bottom:        calc(100% + var(--space-2));
    left:          var(--space-3);
    width:         min(340px, calc(100vw - var(--space-6)));
    background:    var(--surface-elevated);
    border:        1px solid var(--border-light);
    border-radius: var(--radius-xl);
    box-shadow:    var(--shadow-xl);
    z-index:       var(--z-dropdown);
    overflow:      hidden;
    animation:     scaleIn 150ms ease both;
    transform-origin: bottom left;
}
.emoji-panel[hidden] { display: none; }
[dir="rtl"] .emoji-panel { left: auto; right: var(--space-3); transform-origin: bottom right; }

.emoji-panel__search {
    padding:    var(--space-2);
    border-bottom: 1px solid var(--border-light);
}
.emoji-panel__search-input {
    width:         100%;
    height:        32px;
    padding:       0 var(--space-3);
    background:    var(--input-bg);
    border-radius: var(--radius-full);
    font-size:     var(--text-sm);
    color:         var(--text);
}
.emoji-panel__search-input::placeholder { color: var(--input-placeholder); }
.emoji-panel__search-input:focus        { outline: none; }

.emoji-panel__cats {
    display:        flex;
    overflow-x:     auto;
    scrollbar-width:none;
    border-bottom:  1px solid var(--border-light);
    padding:        var(--space-1) var(--space-2);
    gap:            2px;
}
.emoji-panel__cats::-webkit-scrollbar { display: none; }

.emoji-panel__cat {
    padding:       var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size:     18px;
    cursor:        pointer;
    transition:    background var(--transition-fast);
    flex-shrink:   0;
    line-height:   1;
}
.emoji-panel__cat:hover  { background: var(--overlay-light); }
.emoji-panel__cat.active { background: var(--primary-light); }

.emoji-panel__grid {
    display:         grid;
    grid-template-columns: repeat(8, 1fr);
    gap:             2px;
    padding:         var(--space-2);
    max-height:      220px;
    overflow-y:      auto;
}
.emoji-btn {
    font-size:     20px;
    width:         36px;
    height:        36px;
    display:       flex;
    align-items:   center;
    justify-content:center;
    border-radius: var(--radius-sm);
    cursor:        pointer;
    transition:    background var(--transition-fast),
    transform  var(--transition-spring);
    line-height:   1;
    user-select:   none;
}
.emoji-btn:hover { background: var(--overlay-light); transform: scale(1.2); }

/* ──────────────────────────────────────────────────────────
   18. MESSAGE CONTEXT MENU
────────────────────────────────────────────────────────── */
.msg-ctx-menu {
    position:      fixed;
    min-width:     200px;
    background:    var(--surface-elevated);
    border:        1px solid var(--border-light);
    border-radius: var(--radius-xl);
    box-shadow:    var(--shadow-xl);
    z-index:       var(--z-tooltip);
    overflow:      hidden;
    animation:     scaleIn 100ms ease both;
    padding:       var(--space-1);
}

.msg-ctx-item {
    display:       flex;
    align-items:   center;
    gap:           var(--space-3);
    padding:       var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    font-size:     var(--text-sm);
    color:         var(--text);
    cursor:        pointer;
    transition:    background var(--transition-fast);
    white-space:   nowrap;
}
.msg-ctx-item:hover              { background: var(--surface-3); }
.msg-ctx-item--danger            { color: var(--text-danger); }
.msg-ctx-item--danger:hover      { background: var(--danger-light); }
.msg-ctx-item svg                { width: 16px; height: 16px; flex-shrink: 0; }
.msg-ctx-divider {
    height:     1px;
    background: var(--border-light);
    margin:     var(--space-1) 0;
}

/* ──────────────────────────────────────────────────────────
   19. MULTI-SELECT BAR
────────────────────────────────────────────────────────── */
.msg-select-bar {
    position:      absolute;
    top:           0;
    left:          0;
    right:         0;
    display:       flex;
    align-items:   center;
    gap:           var(--space-3);
    padding:       0 var(--space-4);
    height:        60px;
    background:    var(--primary);
    color:         white;
    z-index:       var(--z-sticky);
    animation:     slideDown var(--transition-base) both;
}
.msg-select-bar__count {
    flex:        1;
    font-size:   var(--text-md);
    font-weight: var(--weight-semibold);
}
.msg-select-bar__actions {
    display:     flex;
    align-items: center;
    gap:         var(--space-1);
}
.msg-select-bar__btn {
    color:      white;
    opacity:    0.85;
    transition: opacity var(--transition-fast);
}
.msg-select-bar__btn:hover { opacity: 1; }

/* Checkbox on selected row */
.msg-row__checkbox {
    position:   absolute;
    left:       var(--space-2);
    top:        50%;
    transform:  translateY(-50%);
    width:      20px;
    height:     20px;
    border:     2px solid var(--border);
    border-radius: 50%;
    background: var(--surface);
    display:    flex;
    align-items:center;
    justify-content:center;
    transition: all var(--transition-base);
    cursor:     pointer;
}
.msg-row--selected .msg-row__checkbox {
    background:   var(--primary);
    border-color: var(--primary);
}
.msg-row--selected .msg-row__checkbox::after {
    content: '';
    width:   5px;
    height:  9px;
    border:  2px solid white;
    border-top: none;
    border-left:none;
    transform: rotate(45deg) translate(-1px, -1px);
}

/* ──────────────────────────────────────────────────────────
   20. SCROLL TO BOTTOM BUTTON
────────────────────────────────────────────────────────── */
.scroll-to-bottom {
    position:        absolute;
    bottom:          calc(var(--chat-input-height, 64px) + var(--space-3));
    right:           var(--space-4);
    width:           40px;
    height:          40px;
    background:      var(--surface-elevated);
    border:          1px solid var(--border-light);
    border-radius:   50%;
    display:         flex;
    align-items:     center;
    justify-content: center;
    box-shadow:      var(--shadow-md);
    cursor:          pointer;
    color:           var(--text-secondary);
    transition:      opacity   var(--transition-base),
    transform var(--transition-spring);
    z-index:         var(--z-sticky);
}
.scroll-to-bottom[hidden] { display: none; }
.scroll-to-bottom:hover   { transform: scale(1.08); }
.scroll-to-bottom svg     { width: 20px; height: 20px; }
[dir="rtl"] .scroll-to-bottom { right: auto; left: var(--space-4); }

.scroll-to-bottom__badge {
    position:      absolute;
    top:           -6px;
    right:         -6px;
    min-width:     18px;
    height:        18px;
    padding:       0 4px;
    background:    var(--primary);
    color:         white;
    font-size:     10px;
    font-weight:   var(--weight-bold);
    border-radius: var(--radius-full);
    display:       flex;
    align-items:   center;
    justify-content:center;
    line-height:   1;
    border:        2px solid var(--surface);
}

/* ──────────────────────────────────────────────────────────
   21. PINNED MESSAGE BAR
────────────────────────────────────────────────────────── */
.pinned-msg-bar {
    display:     flex;
    align-items: center;
    gap:         var(--space-3);
    padding:     var(--space-2) var(--space-4);
    background:  var(--surface);
    border-bottom:1px solid var(--border-light);
    cursor:      pointer;
    transition:  background var(--transition-fast);
    flex-shrink: 0;
}
.pinned-msg-bar:hover { background: var(--surface-3); }
.pinned-msg-bar__icon { color: var(--primary); flex-shrink: 0; }
.pinned-msg-bar__icon svg { width: 16px; height: 16px; }
.pinned-msg-bar__body { flex: 1; min-width: 0; }
.pinned-msg-bar__label {
    font-size:   var(--text-xs);
    font-weight: var(--weight-semibold);
    color:       var(--primary);
}
.pinned-msg-bar__text {
    font-size:     var(--text-xs);
    color:         var(--text-muted);
    overflow:      hidden;
    white-space:   nowrap;
    text-overflow: ellipsis;
}

/* ──────────────────────────────────────────────────────────
   22. LIGHTBOX
────────────────────────────────────────────────────────── */
.lightbox {
    position:        fixed;
    inset:           0;
    background:      rgba(0,0,0,0.92);
    z-index:         calc(var(--z-modal) + 10);
    display:         flex;
    flex-direction:  column;
    align-items:     center;
    justify-content: center;
    animation:       fadeIn var(--transition-base) both;
}
.lightbox[hidden] { display: none; }

.lightbox__topbar {
    position:      absolute;
    top:           0;
    left:          0;
    right:         0;
    display:       flex;
    align-items:   center;
    gap:           var(--space-3);
    padding:       var(--space-3) var(--space-4);
    padding-top:   calc(var(--space-3) + var(--safe-top));
    background:    linear-gradient(rgba(0,0,0,0.6), transparent);
    color:         white;
    z-index:       1;
}
.lightbox__title {
    flex:        1;
    font-size:   var(--text-md);
    font-weight: var(--weight-semibold);
    color:       white;
    text-align:  center;
}
.lightbox__close,
.lightbox__action {
    color:       rgba(255,255,255,0.8);
    transition:  color var(--transition-fast);
}
.lightbox__close:hover,
.lightbox__action:hover { color: white; }

.lightbox__media {
    max-width:  90vw;
    max-height: 80vh;
    object-fit: contain;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-xl);
    user-select:none;
    -webkit-user-drag: none;
}

.lightbox__nav {
    position:  absolute;
    top:       50%;
    transform: translateY(-50%);
    color:     rgba(255,255,255,0.7);
    background:rgba(0,0,0,0.4);
    border-radius:50%;
    width:     44px;
    height:    44px;
    display:   flex;
    align-items:center;
    justify-content:center;
    cursor:    pointer;
    transition:color      var(--transition-fast),
    background var(--transition-fast);
}
.lightbox__nav:hover    { color: white; background: rgba(0,0,0,0.6); }
.lightbox__nav--prev    { left:  var(--space-4); }
.lightbox__nav--next    { right: var(--space-4); }
.lightbox__nav svg      { width: 22px; height: 22px; }
.lightbox__nav[disabled]{ opacity: 0.3; cursor: default; }

.lightbox__caption {
    position:   absolute;
    bottom:     var(--space-6);
    left:       50%;
    transform:  translateX(-50%);
    color:      rgba(255,255,255,0.85);
    font-size:  var(--text-sm);
    background: rgba(0,0,0,0.4);
    padding:    var(--space-1) var(--space-4);
    border-radius: var(--radius-full);
    white-space:nowrap;
    max-width:  80vw;
    overflow:   hidden;
    text-overflow: ellipsis;
}

/* ──────────────────────────────────────────────────────────
   23. SECRET CHAT INDICATOR
────────────────────────────────────────────────────────── */
.secret-chat-banner {
    display:         flex;
    align-items:     center;
    justify-content: center;
    gap:             var(--space-2);
    padding:         var(--space-2) var(--space-4);
    background:      var(--success-light);
    border-bottom:   1px solid rgba(76,175,80,0.2);
    font-size:       var(--text-xs);
    color:           var(--text-success);
    font-weight:     var(--weight-medium);
    flex-shrink:     0;
}
.secret-chat-banner svg { width: 14px; height: 14px; }

/* ──────────────────────────────────────────────────────────
   24. EMPTY CHAT  (no messages yet)
────────────────────────────────────────────────────────── */
.chat-empty {
    flex:            1;
    display:         flex;
    flex-direction:  column;
    align-items:     center;
    justify-content: center;
    text-align:      center;
    padding:         var(--space-8);
    gap:             var(--space-3);
    color:           var(--text-muted);
    pointer-events:  none;
    user-select:     none;
}
.chat-empty__icon  { font-size: 48px; opacity: 0.5; }
.chat-empty__title {
    font-size:   var(--text-lg);
    font-weight: var(--weight-semibold);
    color:       var(--text-secondary);
}
.chat-empty__sub   {
    font-size:   var(--text-sm);
    max-width:   260px;
    line-height: var(--leading-relaxed);
}
.chat-empty__sub a {
    pointer-events: all;
    color: var(--primary);
}

/* ──────────────────────────────────────────────────────────
   25. SKELETON MESSAGES
────────────────────────────────────────────────────────── */
.msg-skeleton {
    display:     flex;
    align-items: flex-end;
    gap:         var(--space-2);
    padding:     var(--space-1) 0;
}
.msg-skeleton--out { flex-direction: row-reverse; }

.msg-skeleton__bubble {
    display:        flex;
    flex-direction: column;
    gap:            var(--space-1);
    padding:        var(--space-2) var(--space-3);
    background:     var(--surface-3);
    border-radius:  var(--radius-xl);
    animation:      shimmer 1.4s ease-in-out infinite;
    background-image: linear-gradient(
            90deg,
            var(--surface-3) 0%,
            var(--border-light) 50%,
            var(--surface-3) 100%
    );
    background-size: 200% 100%;
}
